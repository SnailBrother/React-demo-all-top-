æˆ‘æƒ³è¦åœ¨MusicContext.jsçš„æ·»åŠ ä¸€ä¸ª
//æ·»åŠ æˆ¿é—´ç›¸å…³çŠ¶æ€
currentRoom:null.
isInRoom: false,
roomUsers:[],
isHost: false,ç„¶åå†TogetherRoomManagerå¦‚æœå‡å¦‚äº†æˆ¿é—´ï¼Œå°±å¯ä»¥è·å–å‡ºæ¥å€¼ï¼Œå…¶ä»–çš„ä¸ç”¨ä½ ä¿®æ”¹é‚£ä¹ˆå¤šï¼Œåªéœ€è¦æˆ‘ç»™çš„è¿™ä¸ªï¼Œæ€ä¹ˆæ“ä½œï¼Œé«˜æ•°æˆ‘ä¿®æ”¹å“ªé‡Œå°±è¡Œ


1. ä¿®æ”¹ MusicContext.js
javascript
// src/context/MusicContext.js

// åˆå§‹çŠ¶æ€ - æ·»åŠ æˆ¿é—´ç›¸å…³çŠ¶æ€
const initialState = {
  currentSong: null,
  isPlaying: false,
  volume: 1,
  queue: [],
  currentIndex: -1,
  progress: 0,
  duration: 0,
  // æ·»åŠ æˆ¿é—´ç›¸å…³çŠ¶æ€
  currentRoom: null,
  isInRoom: false,
  roomUsers: [],
  isHost: false,
};

// Reducer - æ·»åŠ æˆ¿é—´çŠ¶æ€æ›´æ–°
function musicReducer(state, action) {
  switch (action.type) {
    // ... å…¶ä»–å·²æœ‰çš„ case ...
    
    case 'PLAY_SONG':
      return {
        ...state,
        currentSong: action.payload.song,
        queue: action.payload.queue,
        currentIndex: action.payload.index,
        isPlaying: true,
        progress: 0,
      };
    
    // æ–°å¢ï¼šè®¾ç½®æˆ¿é—´ä¿¡æ¯
    case 'SET_ROOM_INFO':
      return {
        ...state,
        currentRoom: action.payload.room,
        isInRoom: action.payload.isInRoom,
        roomUsers: action.payload.roomUsers || [],
        isHost: action.payload.isHost || false,
      };
    
    // æ–°å¢ï¼šæ¸…é™¤æˆ¿é—´ä¿¡æ¯
    case 'CLEAR_ROOM_INFO':
      return {
        ...state,
        currentRoom: null,
        isInRoom: false,
        roomUsers: [],
        isHost: false,
      };
    
    // æ–°å¢ï¼šæ›´æ–°æˆ¿é—´ç”¨æˆ·åˆ—è¡¨
    case 'UPDATE_ROOM_USERS':
      return {
        ...state,
        roomUsers: action.payload.users || [],
      };
    
    default:
      return state;
  }
}

// ... å…¶ä»–ä»£ç ä¿æŒä¸å˜ ...
2. ä¿®æ”¹ TogetherRoomManager.js
åœ¨ TogetherRoomManager ç»„ä»¶ä¸­æ·»åŠ å¯¹éŸ³ä¹ä¸Šä¸‹æ–‡çš„å¼•ç”¨ï¼Œå¹¶åœ¨åŠ å…¥/ç¦»å¼€æˆ¿é—´æ—¶æ›´æ–°çŠ¶æ€ï¼š

javascript
// src/components/modules/music/TogetherRoomManager.js
import React, { useState, useEffect, useCallback } from 'react';
import { useAuth } from '../../../context/AuthContext';
import { useMusic } from '../../../context/MusicContext'; // æ–°å¢å¯¼å…¥
import axios from 'axios';
import { ConfirmationDialog } from '../../../components/UI';
import styles from './TogetherRoomManager.module.css';
import io from 'socket.io-client';

const TogetherRoomManager = () => {
    const [rooms, setRooms] = useState([]);
    const { user, isAuthenticated } = useAuth();
    const { dispatch } = useMusic(); // æ–°å¢ï¼šè·å– dispatch å‡½æ•°
    
    // ... å…¶ä»–çŠ¶æ€ä¿æŒä¸å˜ ...

    // åœ¨è·å–æˆ¿é—´åˆ—è¡¨åï¼Œæ£€æŸ¥ç”¨æˆ·æ˜¯å¦åœ¨æˆ¿é—´ä¸­å¹¶æ›´æ–°çŠ¶æ€
    useEffect(() => {
        if (currentUserRoom) {
            // ç”¨æˆ·åœ¨å½“å‰æˆ¿é—´ï¼Œæ›´æ–°éŸ³ä¹ä¸Šä¸‹æ–‡
            dispatch({
                type: 'SET_ROOM_INFO',
                payload: {
                    room: currentUserRoom,
                    isInRoom: true,
                    roomUsers: currentUserRoom.users || [],
                    isHost: currentUserRoom.host === user.email
                }
            });
        } else {
            // ç”¨æˆ·ä¸åœ¨ä»»ä½•æˆ¿é—´ï¼Œæ¸…é™¤æˆ¿é—´ä¿¡æ¯
            dispatch({ type: 'CLEAR_ROOM_INFO' });
        }
    }, [currentUserRoom, user.email, dispatch]);

    // åœ¨åŠ å…¥æˆ¿é—´æˆåŠŸåæ›´æ–°çŠ¶æ€
    const joinRoom = async (e) => {
        e.preventDefault();
        setLoading(true);
        setError('');
        try {
            const response = await axios.post('/api/ReactDemomusic-rooms/join', {
                room_name: joinRoomName,
                password: joinPassword || null,
                email: user.email
            });
            setShowJoinForm(false);
            setJoinRoomName('');
            setJoinPassword('');
            
            // åŠ å…¥æˆåŠŸåï¼ŒSocket.IO ä¼šè‡ªåŠ¨å¹¿æ’­ rooms-updated äº‹ä»¶
            alert('åŠ å…¥æˆ¿é—´æˆåŠŸï¼');
            
            // çŠ¶æ€æ›´æ–°ä¼šåœ¨ä¸Šé¢çš„ useEffect ä¸­è‡ªåŠ¨å¤„ç†
        } catch (err) {
            // ... é”™è¯¯å¤„ç†ä¿æŒä¸å˜ ...
        } finally {
            setLoading(false);
        }
    };

    // åœ¨ç¦»å¼€æˆ¿é—´å’Œåˆ é™¤æˆ¿é—´æ—¶ï¼ŒçŠ¶æ€ä¼šè‡ªåŠ¨æ¸…é™¤ï¼ˆå› ä¸º currentUserRoom å˜ä¸º nullï¼‰

    // ... å…¶ä»–ä»£ç ä¿æŒä¸å˜ ...
};

export default TogetherRoomManager;
3. åœ¨å…¶ä»–ç»„ä»¶ä¸­ä½¿ç”¨æˆ¿é—´çŠ¶æ€
ç°åœ¨ä½ å¯ä»¥åœ¨ä»»ä½•ä½¿ç”¨ useMusic çš„ç»„ä»¶ä¸­è®¿é—®æˆ¿é—´çŠ¶æ€äº†ï¼š

javascript
// åœ¨ä»»ä½•ç»„ä»¶ä¸­
import { useMusic } from '../context/MusicContext';

const SomeComponent = () => {
  const { state } = useMusic();
  
  // è®¿é—®æˆ¿é—´çŠ¶æ€
  const { currentRoom, isInRoom, roomUsers, isHost } = state;
  
  // ä½¿ç”¨è¿™äº›çŠ¶æ€...
};
ä¸»è¦ä¿®æ”¹æ€»ç»“ï¼š
MusicContext.js:

åœ¨ initialState ä¸­æ·»åŠ äº†æˆ¿é—´ç›¸å…³çŠ¶æ€

åœ¨ reducer ä¸­æ·»åŠ äº†è®¾ç½®ã€æ¸…é™¤å’Œæ›´æ–°æˆ¿é—´çŠ¶æ€çš„ action

TogetherRoomManager.js:

å¯¼å…¥ useMusic è·å– dispatch å‡½æ•°

æ·»åŠ  useEffect ç›‘å¬å½“å‰æˆ¿é—´å˜åŒ–å¹¶è‡ªåŠ¨æ›´æ–°éŸ³ä¹ä¸Šä¸‹æ–‡çŠ¶æ€

åŠ å…¥/ç¦»å¼€æˆ¿é—´æ—¶çŠ¶æ€ä¼šè‡ªåŠ¨åŒæ­¥

è¿™æ ·ä¿®æ”¹åï¼Œå½“ä½ åŠ å…¥æˆ¿é—´æ—¶ï¼ŒéŸ³ä¹ä¸Šä¸‹æ–‡ä¼šè‡ªåŠ¨æ›´æ–°æˆ¿é—´ä¿¡æ¯ï¼Œå…¶ä»–ç»„ä»¶å¯ä»¥é€šè¿‡ useMusic hook è·å–è¿™äº›çŠ¶æ€ã€‚

// è®¿é—®æˆ¿é—´çŠ¶æ€
  const { currentRoom, isInRoom, roomUsers, isHost } = state;è¿™äº›å€¼æˆ‘æƒ³è¦ç”¨pæ ‡ç­¾æ˜¾ç¤ºå‡ºæ¥å‘¢
æƒ³è¦ç”¨ p æ ‡ç­¾æ˜¾ç¤ºè¿™äº›æˆ¿é—´çŠ¶æ€ï¼Œä½ å¯ä»¥åœ¨ä»»ä½•ä½¿ç”¨ useMusic çš„ç»„ä»¶ä¸­æ·»åŠ æ˜¾ç¤ºä»£ç ã€‚è¿™é‡Œç»™ä½ å‡ ä¸ªç¤ºä¾‹ï¼š

ç¤ºä¾‹ 1ï¼šåœ¨æ’­æ”¾å™¨ç»„ä»¶ä¸­æ˜¾ç¤º
javascript
// src/components/modules/music/MusicPlayer.js (æˆ–å…¶ä»–æ’­æ”¾å™¨ç»„ä»¶)
import React from 'react';
import { useMusic } from '../../../context/MusicContext';
import styles from './MusicPlayer.module.css';

const MusicPlayer = () => {
  const { state } = useMusic();
  
  // è®¿é—®æˆ¿é—´çŠ¶æ€
  const { currentRoom, isInRoom, roomUsers, isHost } = state;

  return (
    <div className={styles.musicPlayer}>
      {/* åŸæœ‰çš„æ’­æ”¾å™¨å†…å®¹ */}
      
      {/* æ–°å¢ï¼šæ˜¾ç¤ºæˆ¿é—´çŠ¶æ€ */}
      <div className={styles.roomStatus}>
        <h4>æˆ¿é—´çŠ¶æ€</h4>
        <p>æ˜¯å¦åœ¨æˆ¿é—´ä¸­: {isInRoom ? 'æ˜¯' : 'å¦'}</p>
        {isInRoom && currentRoom && (
          <>
            <p>æˆ¿é—´åç§°: {currentRoom.room_name}</p>
            <p>æˆ¿ä¸»: {currentRoom.host}</p>
            <p>ä½ çš„èº«ä»½: {isHost ? 'æˆ¿ä¸» ğŸ‘‘' : 'æˆå‘˜'}</p>
            <p>æˆ¿é—´äººæ•°: {roomUsers.length} / {currentRoom.max_users}</p>
            <p>åœ¨çº¿ç”¨æˆ·:</p>
            <ul>
              {roomUsers.map((user, index) => (
                <li key={index}>
                  {user.email} {user.email === currentRoom.host ? 'ğŸ‘‘' : ''}
                </li>
              ))}
            </ul>
          </>
        )}
        {!isInRoom && (
          <p>å½“å‰æœªåŠ å…¥ä»»ä½•æˆ¿é—´</p>
        )}
      </div>
    </div>
  );
};

export default MusicPlayer;
ç¤ºä¾‹ 2ï¼šåœ¨å•ç‹¬çš„ç»„ä»¶ä¸­æ˜¾ç¤º
javascript
// src/components/modules/music/RoomStatusDisplay.js
import React from 'react';
import { useMusic } from '../../../context/MusicContext';
import styles from './RoomStatusDisplay.module.css';

const RoomStatusDisplay = () => {
  const { state } = useMusic();
  
  // è®¿é—®æˆ¿é—´çŠ¶æ€
  const { currentRoom, isInRoom, roomUsers, isHost } = state;

  if (!isInRoom) {
    return (
      <div className={styles.roomStatus}>
        <p className={styles.notInRoom}>ğŸµ å½“å‰æœªåŠ å…¥ä»»ä½•ä¸€èµ·å¬æ­Œæˆ¿é—´</p>
      </div>
    );
  }

  return (
    <div className={styles.roomStatus}>
      <h4>ğŸµ ä¸€èµ·å¬æ­Œæˆ¿é—´</h4>
      <p><strong>æˆ¿é—´åç§°:</strong> {currentRoom?.room_name}</p>
      <p><strong>æˆ¿ä¸»:</strong> {currentRoom?.host}</p>
      <p><strong>ä½ çš„èº«ä»½:</strong> {isHost ? 'æˆ¿ä¸» ğŸ‘‘' : 'æˆå‘˜ ğŸ‘¥'}</p>
      <p><strong>æˆ¿é—´äººæ•°:</strong> {roomUsers.length} / {currentRoom?.max_users}</p>
      
      <div className={styles.userList}>
        <p><strong>åœ¨çº¿ç”¨æˆ·:</strong></p>
        <ul>
          {roomUsers.map((user, index) => (
            <li key={index} className={user.email === currentRoom.host ? styles.host : styles.member}>
              {user.email} {user.email === currentRoom.host && 'ğŸ‘‘'}
            </li>
          ))}
        </ul>
      </div>
    </div>
  );
};

export default RoomStatusDisplay;
ç¤ºä¾‹ 3ï¼šåœ¨ TogetherRoomManager ç»„ä»¶å†…éƒ¨æ˜¾ç¤º
javascript
// åœ¨ TogetherRoomManager.js çš„ return è¯­å¥ä¸­æ·»åŠ 
return (
  <div className={styles.roomManager}>
    <div className={styles.header}>
      <h3>ä¸€èµ·å¬æ­Œ ğŸµ</h3>
      
      {/* æ–°å¢ï¼šæ˜¾ç¤ºå½“å‰æˆ¿é—´çŠ¶æ€ */}
      <div className={styles.currentRoomStatus}>
        <p>å½“å‰æˆ¿é—´çŠ¶æ€: {state.isInRoom ? `å·²åŠ å…¥ ${state.currentRoom?.room_name}` : 'æœªåŠ å…¥æˆ¿é—´'}</p>
        <p>ç”¨æˆ·èº«ä»½: {state.isHost ? 'æˆ¿ä¸»' : 'æˆå‘˜'}</p>
        <p>æˆ¿é—´äººæ•°: {state.roomUsers.length}</p>
      </div>
      
      {/* åŸæœ‰çš„å…¶ä»–å†…å®¹ */}
      <div className={styles.connectionStatus}>
        {/* ... */}
      </div>
      {/* ... å…¶ä»–åŸæœ‰ä»£ç  ... */}
    </div>
    {/* ... å…¶ä»–åŸæœ‰ä»£ç  ... */}
  </div>
);
ç¤ºä¾‹ 4ï¼šç®€å•çš„çŠ¶æ€æ˜¾ç¤ºç»„ä»¶
javascript
// src/components/modules/music/SimpleRoomStatus.js
import React from 'react';
import { useMusic } from '../../../context/MusicContext';

const SimpleRoomStatus = () => {
  const { state } = useMusic();
  const { currentRoom, isInRoom, roomUsers, isHost } = state;

  return (
    <div style={{ padding: '10px', border: '1px solid #ccc', margin: '10px 0' }}>
      <p><strong>ä¸€èµ·å¬æ­ŒçŠ¶æ€:</strong></p>
      <p>åœ¨æˆ¿é—´ä¸­: {isInRoom ? 'âœ… æ˜¯' : 'âŒ å¦'}</p>
      {isInRoom && (
        <>
          <p>æˆ¿é—´å: {currentRoom?.room_name}</p>
          <p>èº«ä»½: {isHost ? 'ğŸ‘‘ æˆ¿ä¸»' : 'ğŸ‘¥ æˆå‘˜'}</p>
          <p>äººæ•°: {roomUsers.length}</p>
        </>
      )}
    </div>
  );
};

export default SimpleRoomStatus;
CSS æ ·å¼ç¤ºä¾‹ (RoomStatusDisplay.module.css)
css
.roomStatus {
  background: #f5f5f5;
  border-radius: 8px;
  padding: 15px;
  margin: 10px 0;
  border-left: 4px solid #4CAF50;
}

.notInRoom {
  color: #666;
  font-style: italic;
}

.userList {
  margin-top: 10px;
}

.userList ul {
  list-style: none;
  padding: 0;
  margin: 5px 0;
}

.userList li {
  padding: 2px 5px;
  margin: 2px 0;
}

.host {
  color: #e91e63;
  font-weight: bold;
}

.member {
  color: #333;
}
é€‰æ‹©å…¶ä¸­ä¸€ç§æ–¹å¼ï¼Œåœ¨ä½ æƒ³è¦æ˜¾ç¤ºæˆ¿é—´çŠ¶æ€çš„ç»„ä»¶ä¸­æ·»åŠ ç›¸åº”çš„ä»£ç å³å¯ã€‚å»ºè®®ä»ç®€å•çš„ç¤ºä¾‹å¼€å§‹ï¼Œç„¶åæ ¹æ®éœ€è¦è°ƒæ•´æ ·å¼å’Œå¸ƒå±€ã€‚